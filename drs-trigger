#!/data/spirou/venv/bin/python3

import argparse

def print_version_info(drs, trigger):
    if drs:
        print(drs_version())
    elif trigger:
        print(trigger_version())
    else:
        print('DRS version', drs_version(), '-', 'Trigger version', trigger_version())


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(dest='command')
    subparsers.required = True
    version_parse = subparsers.add_parser('version', help='DRS version information')
    version_flags = version_parse.add_mutually_exclusive_group(required=False)
    version_flags.add_argument('--drs', action='store_true')
    version_flags.add_argument('--trigger', action='store_true')
    realtime_parse = subparsers.add_parser('realtime', help='reduce a file from session directory and update database')
    realtime_parse.add_argument('filepath')
    reduce_file_parse = subparsers.add_parser('file', help='reduce a single file')
    reduce_file_parse.add_argument('night')
    reduce_file_parse.add_argument('filename')
    reduce_sequence_parse = subparsers.add_parser('sequence', help='reduce a sequence of files together')
    reduce_sequence_parse.add_argument('night')
    reduce_sequence_parse.add_argument('filenames', nargs='+')
    reduce_night_parser = subparsers.add_parser('night', help='reduce an entire night')
    reduce_night_parser.add_argument('night')
    reduce_objects_parser = subparsers.add_parser('objects', help='reduce only objects from a night')
    reduce_objects_parser.add_argument('night')
    reduce_calibrations_parser = subparsers.add_parser('calibrations', help='reduce only calibrations from a night')
    reduce_calibrations_parser.add_argument('night')
    listener_parse = subparsers.add_parser('listener', help='run local http listener for automated realtime calls')
    listener_parse.add_argument('port')
    args = parser.parse_args()
    if args.command == 'realtime':
        from realtime import realtime
        realtime(args.filepath)
    elif args.command == 'listener':
        from listener import run_listener
        run_listener(args.port)
    else:
        from drstrigger import drstrigger, reduce_night, drs_version, trigger_version
        if args.command == 'file':
            drstrigger(args.night, file=args.filename)
        elif args.command == 'sequence':
            drstrigger(args.night, sequence=args.filenames)
        elif args.command == 'night':
            reduce_night(args.night)
        elif args.command == 'objects' or args.command == 'calibrations':
            reduce_night(args.night, types=args.command)
        elif args.command == 'version':
            print_version_info(args.drs, args.trigger)
